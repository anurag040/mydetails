<div class="modern-chat-container">
  <!-- Minimal Header -->
  <div class="modern-header">
    <div class="header-content">
      <div class="header-chat-options" *ngIf="!currentDataset">
        <div class="chat-header-compact">
          <h1>Data Assistant</h1>
          <p>Ask me anything about your data</p>
        <div class="all-options-row">
          <button class="chart-option-btn" 
                  [class.active]="selectedPlotType === ''"
                  (click)="selectChart('')">
            <mat-icon>text_fields</mat-icon>
            <span>Text Only</span>
          </button>
          <button class="chart-option-btn" 
                  [class.active]="selectedPlotType === 'line_trend'"
                  (click)="selectChart('line_trend')">
            <mat-icon>show_chart</mat-icon>
            <span>Line Chart</span>
          </button>
          <button class="chart-option-btn" 
                  [class.active]="selectedPlotType === 'bollinger_band'"
                  (click)="selectChart('bollinger_band')">
            <mat-icon>analytics</mat-icon>
            <span>Bollinger Bands</span>
          </button>
          
          <div class="separator"></div>
          
          <button class="quick-action-btn" (click)="askQuickQuestion('Summarize my data')" [disabled]="isLoading">üìä Summarize</button>
          <button class="quick-action-btn" (click)="askQuickQuestion('Show me trends in the data')" [disabled]="isLoading">üìà Trends</button>
          <button class="quick-action-btn" (click)="askQuickQuestion('Find outliers in my data')" [disabled]="isLoading">üéØ Outliers</button>
          <button class="quick-action-btn" (click)="askQuickQuestion('Check for missing values')" [disabled]="isLoading">‚ùì Missing</button>
        </div>
        
        <!-- Chart Settings Dropdown -->
        <div class="chart-settings-dropdown" *ngIf="selectedPlotType">
          <select class="native-select" 
                  [(ngModel)]="selectedColumn"
                  (ngModelChange)="onColumnChange($event)"
                  *ngIf="selectedPlotType === 'bollinger_band' || selectedPlotType === 'line_trend'">
            <option value="">{{ selectedPlotType === 'bollinger_band' ? 'Auto-detect' : 'All columns' }}</option>
            <option *ngFor="let col of getNumericColumns()" [value]="col">{{ col }}</option>
          </select>
          
          <input class="native-input" 
                 type="number" 
                 [(ngModel)]="bollingerWindow" 
                 (ngModelChange)="onWindowChange($event)"
                 min="5" max="50" 
                 placeholder="Window (20)"
                 *ngIf="selectedPlotType === 'bollinger_band'">
        </div>
      </div>
    </div>
  </div>
  
  <!-- Chat Messages Area -->
  <div class="modern-chat-content" [class.with-matrix]="showAnalysisMatrix">
    
    <div class="messages-area" #messagesContainer>
      <!-- Welcome State -->
      <div class="welcome-state" *ngIf="!currentDataset && messages.length === 0">
        <div class="welcome-icon">
          <mat-icon>upload_file</mat-icon>
        </div>
        <h3>Ready to analyze your data</h3>
        <p>Upload a dataset to start our conversation</p>
      </div>
      
      <!-- Empty Chat State -->
      <div class="empty-chat" *ngIf="currentDataset && messages.length === 0">
        <div class="dataset-info">
          <mat-icon>dataset</mat-icon>
          <span>{{ currentDataset.filename }}</span>
          <small>{{ currentDataset.rows.toLocaleString() }} rows</small>
        </div>
        <h3>What would you like to know?</h3>
        <div class="starter-prompts">
          <button mat-stroked-button class="starter-prompt" (click)="currentQuery = 'Give me a summary of this dataset'; sendMessage()">
            <mat-icon>summarize</mat-icon>
            Summarize this dataset
          </button>
          <button mat-stroked-button class="starter-prompt" (click)="currentQuery = 'What are the key insights?'; sendMessage()">
            <mat-icon>insights</mat-icon>
            Show key insights
          </button>
          <button mat-stroked-button class="starter-prompt" (click)="currentQuery = 'Are there any missing values?'; sendMessage()">
            <mat-icon>error_outline</mat-icon>
            Check data quality
          </button>
          <button mat-stroked-button class="starter-prompt" (click)="selectChart('line_trend'); currentQuery = 'Show me trends in the data'; sendMessage()">
            <mat-icon>trending_up</mat-icon>
            Visualize trends
          </button>
        </div>
      </div>

      <!-- Chat Messages -->
      <div class="conversation">
        <div *ngFor="let message of messages; trackBy: trackByIndex"
             class="message-pair"
             [class.has-chart]="message.plotData && message.type === 'ai'">
          
          <!-- Typing Indicator -->
          <div class="typing-indicator" *ngIf="message.content === 'typing-indicator'">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <div class="typing-text">AI is thinking...</div>
          </div>
          
          <!-- Regular Message -->
          <div class="message-content" *ngIf="message.content !== 'typing-indicator'">
            <div class="message-text" [innerHTML]="formatAIResponse(message.content)"></div>
            <div class="message-time">{{ formatTime(message.timestamp) }}</div>
            
            <!-- Chart visualization -->
            <div class="chart-container" *ngIf="message.plotData">
              <div class="chart-header">
                <h4>üìä Data Visualization</h4>
                <button class="chart-fullscreen-btn" title="View Fullscreen">
                  <i class="material-icons">fullscreen</i>
                </button>
              </div>
              <canvas baseChart
                      [data]="getChartData(message.plotData)"
                      [options]="getChartOptions(message.plotData)"
                      [type]="'line'"
                      class="chart-canvas">
              </canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="message-pair typing" *ngIf="isLoading">
        <div class="message assistant">
          <div class="message-avatar">
            <mat-icon>psychology</mat-icon>
          </div>
          <div class="message-content">
            <div class="typing-animation">
              <div class="typing-dots">
                <span></span><span></span><span></span>
              </div>
              <span class="typing-text">Analyzing your data...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Error Message -->
  <div class="error-banner" *ngIf="errorMessage">
    <div class="error-content">
      <i class="material-icons">error_outline</i>
      <span>{{ errorMessage }}</span>
      <button class="retry-btn" (click)="retryLastQuery()" *ngIf="retryCount < maxRetries">
        <i class="material-icons">refresh</i>
        Retry
      </button>
      <button class="close-error-btn" (click)="clearError()">
        <i class="material-icons">close</i>
      </button>
    </div>
  </div>

  <!-- Modern Input Area -->
  <div class="modern-input-area" *ngIf="currentDataset">
    <div class="input-area">
      <div class="input-container">
        <textarea 
          [(ngModel)]="currentQuery" 
          (keydown)="onKeyPress($event)"
          placeholder="{{ getInputPlaceholder() }}"
          class="chat-input"
          rows="1"
          cdkTextareaAutosize
          cdkAutosizeMinRows="1"
          cdkAutosizeMaxRows="4"
          [disabled]="isLoading">
        </textarea>
        <button 
          class="send-button" 
          (click)="sendMessage()" 
          [disabled]="!currentQuery.trim() || isLoading">
          <div class="send-button-content">
            <div class="loading-spinner" *ngIf="isLoading"></div>
            <i class="material-icons" *ngIf="!isLoading">send</i>
          </div>
        </button>
      </div>

    </div>
    
  </div>
</div>
