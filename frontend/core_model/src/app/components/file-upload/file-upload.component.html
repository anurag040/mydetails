<div class="file-upload-container">
  <!-- Backend Status Indicator (just a dot) -->
  <div class="status-indicator" [ngClass]="backendOnline ? 'online' : 'offline'">
    <div class="status-dot"></div>
  </div>

  <!-- Upload Area (show always for debugging) -->
  <mat-card class="upload-card">
    <mat-card-header>
      <mat-card-title>Upload Your Dataset</mat-card-title>
      <mat-card-subtitle>Drag and drop a file or click to browse</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content>
      <div class="upload-area" 
           (drop)="onDrop($event)" 
           (dragover)="onDragOver($event)" 
           (dragleave)="onDragLeave($event)">
        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <p>Drop your CSV, Excel, or JSON file here</p>
        <p class="upload-hint">Or click the button below to browse</p>
        
        <input type="file" 
               #fileInput 
               (change)="onFileSelected($event)" 
               accept=".csv,.xlsx,.xls,.json"
               style="display: none;">
        
        <button mat-raised-button 
                color="primary" 
                (click)="fileInput.click()"
                [disabled]="isUploading">
          <mat-icon>folder_open</mat-icon>
          Browse Files
        </button>
        
        <mat-progress-bar *ngIf="isUploading" mode="indeterminate" class="upload-progress"></mat-progress-bar>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Current Dataset Card -->
  <mat-card class="dataset-card" *ngIf="currentDataset">
    <mat-card-header>
      <mat-icon mat-card-avatar [ngClass]="'file-icon'">{{ getFileIcon(currentDataset.filename) }}</mat-icon>
      <mat-card-title>{{ currentDataset.filename }}</mat-card-title>
      <mat-card-subtitle>{{ formatFileSize(currentDataset.size) }} • {{ formatDate(currentDataset.upload_timestamp) }}</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Dataset Info -->
      <div class="dataset-info">
        <mat-chip-set aria-label="Dataset properties">
          <mat-chip *ngIf="currentDataset.rows">
            <mat-icon matChipAvatar>table_rows</mat-icon>
            {{ currentDataset.rows }} rows
          </mat-chip>
          <mat-chip *ngIf="currentDataset.columns">
            <mat-icon matChipAvatar>view_column</mat-icon>
            {{ currentDataset.columns }} columns
          </mat-chip>
          <mat-chip>
            <mat-icon matChipAvatar>schedule</mat-icon>
            Just uploaded
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Dataset Preview -->
      <mat-expansion-panel *ngIf="datasetPreview" class="preview-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>preview</mat-icon>
            Dataset Preview
          </mat-panel-title>
          <mat-panel-description>
            {{ datasetPreview.shape[0] }} rows × {{ datasetPreview.shape[1] }} columns
          </mat-panel-description>
        </mat-expansion-panel-header>

        <!-- Column Info -->
        <div class="column-info">
          <h4>Columns & Data Types</h4>
          <div class="columns-grid">
            <div class="column-item" *ngFor="let column of datasetPreview.columns.slice(0, 8)">
              <span class="column-name">{{ column }}</span>
              <span class="column-type">{{ datasetPreview.dtypes[column] || 'object' }}</span>
            </div>
            <div *ngIf="datasetPreview.columns.length > 8" class="more-columns">
              +{{ datasetPreview.columns.length - 8 }} more columns
            </div>
          </div>
        </div>

        <!-- Data Preview Table -->
        <div class="table-container">
          <h4>Sample Data</h4>
          <table mat-table [dataSource]="getPreviewRows()" class="preview-table">
            <ng-container *ngFor="let column of getDisplayedColumns()" [matColumnDef]="column">
              <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
              <td mat-cell *matCellDef="let row">{{ row[column] }}</td>
            </ng-container>
            
            <tr mat-header-row *matHeaderRowDef="getDisplayedColumns()"></tr>
            <tr mat-row *matRowDef="let row; columns: getDisplayedColumns()"></tr>
          </table>
          
          <div *ngIf="datasetPreview.columns.length > 5" class="table-note">
            Showing first 5 columns and 10 rows
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Analysis Options -->
      <div class="analysis-actions" *ngIf="showAnalysisOptions">
        <h3>Choose Your Analysis</h3>
        <p class="analysis-description">Select the type of analysis you'd like to perform on your dataset:</p>
        
        <div class="action-buttons">
          <button mat-raised-button color="primary" (click)="selectBasicAnalysis()" class="action-button">
            <mat-icon>analytics</mat-icon>
            <div class="button-content">
              <span class="button-title">Basic Statistics</span>
              <span class="button-subtitle">Quick overview & data quality</span>
            </div>
          </button>

          <button mat-raised-button color="accent" (click)="selectAdvancedAnalysis()" class="action-button">
            <mat-icon>science</mat-icon>
            <div class="button-content">
              <span class="button-title">Advanced Analysis</span>
              <span class="button-subtitle">ML insights & deep analysis</span>
            </div>
          </button>

          <button mat-raised-button color="warn" (click)="openChatWithData()" class="action-button">
            <mat-icon>chat</mat-icon>
            <div class="button-content">
              <span class="button-title">Chat with Data</span>
              <span class="button-subtitle">AI-powered questions & answers</span>
            </div>
          </button>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="removeDataset()" color="warn">
        <mat-icon>delete</mat-icon>
        Remove Dataset
      </button>
      <button mat-button (click)="fileInput.click()">
        <mat-icon>upload</mat-icon>
        Upload New File
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Hidden file input for new uploads -->
  <input type="file" 
         #fileInput 
         (change)="onFileSelected($event)" 
         accept=".csv,.xlsx,.xls,.json"
         style="display: none;">
</div>
