// src/app/activity.service.ts
import { Injectable, NgZone } from '@angular/core';
import { Idle, DEFAULT_INTERRUPTSOURCES } from '@ng-idle/core';
import { Keepalive } from '@ng-idle/keepalive';

@Injectable({ providedIn: 'root' })
export class ActivityService {
  private channel: BroadcastChannel;

  constructor(
    private idle: Idle,
    private keepalive: Keepalive,
    private ngZone: NgZone
  ) {
    this.channel = new BroadcastChannel('user-activity');
    this.idle.setIdle(300);
    this.idle.setTimeout(30);
    this.idle.setInterrupts(DEFAULT_INTERRUPTSOURCES);
    this.idle.onInterrupt.subscribe(() => this.channel.postMessage('active'));
    this.channel.onmessage = msg => {
      if (msg.data === 'active') {
        this.ngZone.run(() => this.idle.watch());
      }
    };
    this.keepalive.interval(60);
    this.keepalive.onPing.subscribe(() => {});
    this.idle.watch();
  }
}


// src/app/app.module.ts
import { NgModule } from '@angular/core';
import { BrowserModule } from '@angular/platform-browser';
import { NgIdleModule } from '@ng-idle/core';
import { KeepaliveModule } from '@ng-idle/keepalive';
import { AppComponent } from './app.component';

@NgModule({
  declarations: [AppComponent],
  imports: [
    BrowserModule,
    NgIdleModule.forRoot(),
    KeepaliveModule.forRoot()
  ],
  bootstrap: [AppComponent]
})
export class AppModule {}
